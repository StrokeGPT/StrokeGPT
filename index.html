<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StrokeGPT</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root {
      --background-primary: #121212;
      --background-secondary: #1E1E1E;
      --background-tertiary: #2C2C2C;
      --text-primary: #EAEAEA;
      --text-secondary: #B3B3B3;
      --accent-primary: #007AFF;
      --accent-hover: #0056b3;
      --user-bubble-bg: #267dff;
      --bot-bubble-bg: #3E4042;
      --border-color: #333333;
      --shadow-color: rgba(0, 0, 0, 0.5);
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --red: var(--danger-color); /* For visualizer */
      --green: var(--success-color); /* For visualizer */
    }

    * {
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: var(--background-tertiary) var(--background-primary);
    }
    
    *::-webkit-scrollbar {
      width: 8px;
    }

    *::-webkit-scrollbar-track {
      background: var(--background-primary);
    }

    *::-webkit-scrollbar-thumb {
      background-color: var(--background-tertiary);
      border-radius: 10px;
      border: 2px solid var(--background-primary);
    }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      color: var(--text-primary);
      background: var(--background-primary);
      height: 100%;
      overflow: hidden;
      display: grid;
      grid-template-columns: 1fr 340px;
      transition: grid-template-columns 0.35s ease-in-out;
    }

    body.sidebar-collapsed {
      grid-template-columns: 1fr 0;
    }

    #main-area {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }

    #sidebar {
      padding: 20px;
      background: var(--background-secondary);
      height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 25px;
      border-left: 1px solid var(--border-color);
      transition: all 0.35s ease-in-out;
      overflow-x: hidden;
    }
    
    body.sidebar-collapsed #sidebar {
        padding: 20px 0;
    }

    #top-bar {
      padding: 10px 20px;
      background: var(--background-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      flex-shrink: 0;
      border-bottom: 1px solid var(--border-color);
    }

    #toggle-sidebar-btn {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      background: var(--background-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease-in-out;
    }

    #toggle-sidebar-btn:hover {
      background: var(--accent-primary);
      color: white;
    }

    body.sidebar-collapsed #toggle-sidebar-btn {
      transform: translateY(-50%) rotate(180deg);
    }

    #top-bar h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 1px;
    }

    #top-bar .top-bar-info {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-right: 50px;
    }

    #mood-display, #edging-timer {
      background: var(--background-tertiary);
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 0.9em;
      font-weight: 500;
      border: 1px solid var(--border-color);
    }

    #edging-timer {
      color: var(--warning-color);
      font-weight: 600;
    }

    #chat-view {
      flex: 1;
      min-height: 0;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #bottom-input-area {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      background: var(--background-primary);
      flex-shrink: 0;
    }

    .chat-message-container {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      max-width: 85%;
    }
    
    .bot-bubble {
        align-self: flex-start;
    }
    
    .user-bubble {
        align-self: flex-end;
    }
    
    .user-bubble .message-content {
        align-items: flex-end;
    }

    .chat-pfp {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      border: 2px solid var(--border-color);
    }

    .message-content {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .message-bubble {
      padding: 12px 18px;
      border-radius: 20px;
      line-height: 1.6;
      word-wrap: break-word;
      font-size: 1rem;
    }

    .bot-bubble .message-bubble {
      background: var(--bot-bubble-bg);
      border-top-left-radius: 5px;
      color: var(--text-primary);
    }

    .user-bubble .message-bubble {
      background: var(--user-bubble-bg);
      color: white;
      border-top-right-radius: 5px;
    }

    .speaker-name {
      font-size: 0.85em;
      color: var(--text-secondary);
      font-weight: 600;
      padding: 0 10px;
    }
    
    .input-text, .select-box, input[type="number"], textarea, .my-button {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--background-tertiary);
      color: var(--text-primary);
      outline: none;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease-in-out;
    }

    .input-text:focus, .select-box:focus, input[type="number"]:focus, textarea:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
    }

    #message-input-line {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .my-button {
        background-color: var(--accent-primary);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }
    
    .my-button:hover:not(:disabled) {
        background-color: var(--accent-hover);
    }
    
    .my-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #message-input-line .my-button {
      width: auto;
      flex-shrink: 0;
    }

    #message-input-line .input-text {
      flex-grow: 1;
    }

    .radio-group {
      display: flex;
      justify-content: space-around;
      background: var(--background-tertiary);
      border-radius: 10px;
      padding: 5px;
      border: 1px solid var(--border-color);
    }

    .radio-group input {
      display: none;
    }

    .radio-group label {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease-in-out;
    }

    .radio-group input:checked + label {
      background: var(--accent-primary);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    #status-text {
      margin-top: 15px;
      font-size: 0.9em;
      text-align: center;
      color: var(--text-secondary);
      min-height: 1.2em;
    }
    
    .setting-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .setting-section h3 {
        margin: 0 0 5px 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
    }

    .timing-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .timing-row label {
      flex-basis: 50px;
      font-size: 0.9em;
      color: var(--text-secondary);
    }
    
    .timing-row input {
        text-align: center;
    }

    .typing-dots span {
      display: inline-block;
      animation: blink 1.4s infinite both;
      font-size: 1.5em;
      line-height: 1;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0% {
        opacity: 0.2;
      }
      20% {
        opacity: 1;
      }
      100% {
        opacity: 0.2;
      }
    }
    
    .sidebar-button.stop { background-color: var(--danger-color); }
    .sidebar-button.stop:hover { background-color: #a72835; }
    .sidebar-button.edging { background-color: var(--warning-color); color: #121212; }
    .sidebar-button.edging:hover { background-color: #dba90e; }
    .sidebar-button.milking { background-color: #9c27b0; }
    .sidebar-button.milking:hover { background-color: #7b1fa2; }
    
    .audio-toggle-line {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
    }

    /* Onboarding Modal Styles */
    #onboarding-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    #onboarding-modal {
        background-color: var(--background-secondary);
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 30px var(--shadow-color);
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    #onboarding-modal h2 {
        margin: 0 0 5px 0;
        text-align: center;
        color: var(--text-primary);
    }
    
    #onboarding-modal p {
        margin: 0 0 15px 0;
        text-align: center;
        color: var(--text-secondary);
    }

    #onboarding-modal label {
        font-weight: 600;
        margin-bottom: -5px;
        color: var(--text-secondary);
    }
    
    .onboarding-note {
        font-size: 0.8rem;
        color: var(--text-secondary);
        opacity: 0.8;
        margin: -10px 0 0 5px;
    }

    .onboarding-sliders {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 10px;
    }
    
    .slider-group input[type="range"] {
        width: 100%;
    }

  </style>
</head>
<body>
  <div id="main-area">
    <div id="top-bar">
      <h1>StrokeGPT</h1>
      <div class="top-bar-info">
        <div id="mood-display">Mood: Curious 🤔</div>
        <div id="edging-timer" style="display:none;">Edging: 0m 00s</div>
      </div>
      <button id="toggle-sidebar-btn">⟨</button>
    </div>

    <div id="chat-view">
      <div id="chat-messages-container" style="flex:0 0 auto; display: flex; flex-direction: column; gap: 15px;"></div>
      <div id="typing-indicator" class="chat-message-container bot-bubble" style="display:none;">
        <img id="typing-indicator-pfp" class="chat-pfp" src="/static/default-pfp.png" alt="AI PFP">
        <div class="message-content">
          <div class="speaker-name">BOT</div>
          <div class="message-bubble"><div class="typing-dots"><span>.</span><span>.</span><span>.</span></div></div>
        </div>
      </div>
    </div>

    <div id="bottom-input-area">
      <div id="rhythm-visualizer" style="height:80px;background:var(--background-secondary);border:1px solid var(--border-color);border-radius:10px;margin-bottom:15px; overflow: hidden;">
        <canvas id="rhythm-canvas" style="width:100%;height:100%;"></canvas>
      </div>
      <div id="message-input-line">
        <input id="user-chat-input" class="input-text" placeholder="Type here..."/>
        <button id="send-chat-btn" class="my-button">Send</button>
      </div>
      <div id="status-text">Status: Checking for saved settings...</div>
    </div>
  </div>

  <div id="sidebar">
    <div class="setting-section">
      <h3>Persona</h3>
      <label for="pfp-upload" style="cursor:pointer;display:block;margin-bottom:10px;">
        <img id="ai-pfp-preview" src="/static/default-pfp.png" style="width:100px;height:100px;border-radius:50%;object-fit:cover;margin:10px auto;display:block;border:3px solid var(--border-color);" />
      </label>
      <input type="file" id="pfp-upload" accept="image/*" style="display:none"/>
      <input type="text" id="ai-name-input" class="input-text" placeholder="AI's Name..." />
      <button id="set-ai-name-btn" class="my-button">Set Name</button>
      <textarea id="persona-input" class="input-text" placeholder="Describe the AI's persona..." rows="3"></textarea>
      <button id="set-persona-btn" class="my-button">Set Persona</button>
      <div class="setting-subsection" style="margin-top:10px;">
        <label>Reply Length</label>
        <div class="radio-group">
          <input type="radio" id="len-short" name="reply-length" value="short"><label for="len-short">Short</label>
          <input type="radio" id="len-medium" name="reply-length" value="medium" checked><label for="len-medium">Medium</label>
          <input type="radio" id="len-long" name="reply-length" value="long"><label for="len-long">Long</label>
        </div>
      </div>
    </div>

    <div class="setting-section">
      <h3>Mode Timings (Seconds)</h3>
      <div class="timing-row"><label>Auto</label><input type="number" class="input-text" id="auto-min-time" min="0.5" max="60" step="0.5" value="4"><span>-</span><input type="number" class="input-text" id="auto-max-time" min="1" max="60" step="1" value="7"></div>
      <div class="timing-row"><label>Edge</label><input type="number" class="input-text" id="edging-min-time" min="0.5" max="60" step="0.5" value="5"><span>-</span><input type="number" class="input-text" id="edging-max-time" min="1" max="60" step="1" value="8"></div>
      <div class="timing-row"><label>Milk</label><input type="number" class="input-text" id="milking-min-time" min="0.3" max="60" step="0.1" value="2.5"><span>-</span><input type="number" class="input-text" id="milking-max-time" min="0.5" max="60" step="0.5" value="4.5"></div>
    </div>

    <div class="setting-section">
      <h3>Audio</h3>
      <input id="elevenlabs-key-input" class="input-text" placeholder="ElevenLabs API key">
      <button id="set-elevenlabs-key-button" class="my-button">Save API Key</button>
      <select id="elevenlabs-voice-select-box" class="select-box" disabled><option>Set API Key to load voices...</option></select>
      <div class="audio-toggle-line"><input type="checkbox" id="enable-audio-checkbox"><label for="enable-audio-checkbox">Enable Audio</label></div>
    </div>

    <div class="setting-section">
      <h3>Control Actions</h3>
      <div style="display:flex;gap:10px;">
        <button id="start-auto-btn" class="my-button" style="flex:1;">Start Auto</button>
        <button id="stop-auto-btn" class="my-button" style="flex:1;">Stop Auto</button>
      </div>
      <div style="display:flex;gap:10px;">
        <button id="like-this-move-btn" class="my-button" style="flex:1;">Like This Move</button>
        <button id="memories-toggle-btn" class="my-button" style="flex:1;">Memories: ON</button>
      </div>
      <button id="im-close-btn" class="my-button sidebar-button milking" style="display:none;">I'm Close!</button>
    </div>

    <div class="setting-section" style="margin-top:auto;">
      <h3>DANGER ZONE</h3>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button id="edging-mode-btn" class="my-button sidebar-button edging">Edge Me</button>
        <button id="milking-mode-btn" class="my-button sidebar-button milking">Milk Me</button>
        <button id="emergency-stop-all-btn" class="my-button sidebar-button stop">STOP EVERYTHING</button>
      </div>
    </div>
  </div>
  
  <div id="onboarding-overlay" style="display: none;">
    <div id="onboarding-modal">
        <h2>Welcome to StrokeGPT</h2>
        <p>Please configure your device and AI persona to get started.</p>
        
        <label for="onboarding-key">Handy Connection Key</label>
        <input type="text" id="onboarding-key" class="input-text" placeholder="Enter your connection key...">
        
        <label for="onboarding-persona">AI Persona</label>
        <textarea id="onboarding-persona" class="input-text" rows="3" placeholder="e.g., a horny catgirl or a sentient but surprisingly spritely block of cheese."></textarea>
        
        <div class="onboarding-sliders">
            <div class="slider-group">
                <label>Speed Range: <span id="onboarding-speed-val">0 - 100</span>%</label>
                <p class="onboarding-note">Note: 15% is often plenty fast enough for a max speed.</p>
                <input type="range" id="onboarding-min-speed" min="0" max="100" value="0">
                <input type="range" id="onboarding-max-speed" min="0" max="100" value="100">
            </div>
            <div class="slider-group">
                <label>Depth Range: <span id="onboarding-depth-val">0 - 100</span>%</label>
                <p class="onboarding-note">The top slider is the base of your dick and the bottom one is your tip. The handy goes from 1 (base) to 100 (tip), so guestimate where your tip is. You can always change it later.</p>
                <input type="range" id="onboarding-min-depth" min="0" max="100" value="0">
                <input type="range" id="onboarding-max-depth" min="0" max="100" value="100">
            </div>
        </div>
        
        <button id="onboarding-save-btn" class="my-button" style="margin-top: 15px;">Save & Start</button>
    </div>
  </div>

  <script>
    const D = document;

    // Elements
    const userChatInput = D.getElementById('user-chat-input');
    const personaInput = D.getElementById('persona-input');
    const aiNameInput = D.getElementById('ai-name-input');
    const elevenLabsKeyInput = D.getElementById('elevenlabs-key-input');
    const setElevenLabsKeyButton = D.getElementById('set-elevenlabs-key-button');
    const statusText = D.getElementById('status-text');
    const moodDisplay = D.getElementById('mood-display');
    const rhythmCanvas = D.getElementById('rhythm-canvas');
    const typingIndicator = D.getElementById('typing-indicator');
    const chatView = D.getElementById('chat-view');
    const chatMessagesContainer = D.getElementById('chat-messages-container');
    const pfpUploadInput = D.getElementById('pfp-upload');
    const pfpPreview = D.getElementById('ai-pfp-preview');
    const typingIndicatorPfp = D.getElementById('typing-indicator-pfp');
    const toggleSidebarBtn = D.getElementById('toggle-sidebar-btn');
    const imCloseBtn = D.getElementById('im-close-btn');
    const onboardingOverlay = D.getElementById('onboarding-overlay');

    let myHandyKey = "";
    let myPersonaDescription = "";
    let replyLength = "medium";
    let ctx = rhythmCanvas.getContext('2d');

    function applySidebarState(){
      const collapsed = localStorage.getItem('sidebar_collapsed') === 'true';
      document.body.classList.toggle('sidebar-collapsed', collapsed);
    }
    toggleSidebarBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('sidebar-collapsed');
      localStorage.setItem('sidebar_collapsed', document.body.classList.contains('sidebar-collapsed'));
    });
    applySidebarState();

    function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function scrollToBottom(){
        setTimeout(() => {
            chatView.scrollTop = chatView.scrollHeight;
        }, 50);
    }

    function updateModeButtons(active){
      const autoBtn = D.getElementById('start-auto-btn');
      const edgeBtn = D.getElementById('edging-mode-btn');
      const milkBtn = D.getElementById('milking-mode-btn');
      const stopAutoBtn = D.getElementById('stop-auto-btn');
      const emergencyBtn = D.getElementById('emergency-stop-all-btn');
      const running = !!active;
      [autoBtn,edgeBtn,milkBtn].forEach(b=>{ if(b) b.disabled = running; });
      if (stopAutoBtn) stopAutoBtn.disabled = !running;
      if (emergencyBtn) emergencyBtn.disabled = false;
      if (imCloseBtn) imCloseBtn.style.display = active === 'edging' ? 'block' : 'none';
    }

    async function apiCall(path, opts={}){
      try{
        const res = await fetch(path, opts);
        if (res.headers.get('content-type')?.includes('audio/')) return await res.arrayBuffer();
        return await res.json();
      }catch(e){
        if (statusText) statusText.textContent = `Error: ${e.message}`;
        return null;
      }
    }

    function addUserMessageToChat(text){
      if (!text) return;
      const div = D.createElement('div');
      div.className = 'chat-message-container user-bubble';
      div.innerHTML = `<div class="message-content"><div class="message-bubble">${escapeHTML(text)}</div></div>`;
      chatMessagesContainer.appendChild(div);
      scrollToBottom();
    }

    async function sendUserMessage(message){
      const text = (message||"").trim();
      
      const currentPersona = personaInput.value.trim();
      if (currentPersona !== myPersonaDescription) {
          myPersonaDescription = currentPersona;
      }

      if (!text && !myPersonaDescription) return;
      
      if (text) {
          addUserMessageToChat(text);
      }
      userChatInput.value = "";
      typingIndicator.style.display = 'flex';
      scrollToBottom();

      const payload = { message: text, key: myHandyKey, persona_desc: myPersonaDescription, reply_length: replyLength };
      await apiCall('/send_message', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    }

    function resizeCanvas(){
      if (!rhythmCanvas.parentElement) return;
      rhythmCanvas.width = rhythmCanvas.parentElement.clientWidth;
      rhythmCanvas.height = rhythmCanvas.parentElement.clientHeight;
    }

    function drawHandyVisualizer(speed, depth){
      const width = rhythmCanvas.width, height = rhythmCanvas.height;
      if (!width || !height) return;
      
      const barHeight = (height/2) - 4;
      const ctx2 = ctx;
      const style = getComputedStyle(document.body);

      ctx2.clearRect(0, 0, width, height);
      
      ctx2.fillStyle = 'rgba(220, 53, 69, 0.2)'; 
      ctx2.fillRect(0, 0, width, barHeight);
      ctx2.fillStyle = style.getPropertyValue('--danger-color').trim();
      ctx2.fillRect(0, 0, (speed/100) * width, barHeight);
      
      ctx2.fillStyle = 'rgba(40, 167, 69, 0.2)';
      ctx2.fillRect(0, barHeight + 8, width, barHeight);
      ctx2.fillStyle = style.getPropertyValue('--success-color').trim();
      ctx2.fillRect(0, barHeight + 8, (100 - depth) / 100 * width, barHeight);
      
      ctx2.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx2.font = "600 12px Inter";
      ctx2.textAlign = 'left';
      ctx2.fillText(`Speed: ${speed}%`, 10, barHeight / 2 + 5);
      ctx2.fillText(`Depth: ${depth}%`, 10, barHeight + 8 + (barHeight / 2) + 5);
    }

    async function startupCheck(){
      const data = await apiCall('/check_settings');
      if (data && data.configured){
        onboardingOverlay.style.display = 'none';
        myPersonaDescription = data.persona || "";
        personaInput.value = myPersonaDescription;
        myHandyKey = data.handy_key || "";
        if (data.ai_name) {
          aiNameInput.value = data.ai_name;
          document.querySelectorAll('.speaker-name').forEach(el=>{
            if (el.textContent === 'BOT') el.textContent = data.ai_name;
          });
        }
        if (data.pfp) { pfpPreview.src = data.pfp; typingIndicatorPfp.src = data.pfp; }
        if (data.timings){
          D.getElementById('auto-min-time').value = data.timings.auto_min;
          D.getElementById('auto-max-time').value = data.timings.auto_max;
          D.getElementById('edging-min-time').value = data.timings.edging_min;
          D.getElementById('edging-max-time').value = data.timings.edging_max;
          D.getElementById('milking-min-time').value = data.timings.milking_min;
          D.getElementById('milking-max-time').value = data.timings.milking_max;
        }
        if (data.elevenlabs_key){
          elevenLabsKeyInput.value = data.elevenlabs_key;
          setElevenLabsKeyButton.click();
        }
        if (data.reply_length){
          const r = D.querySelector(`input[name="reply-length"][value="${data.reply_length}"]`);
          if (r) r.checked = true;
          replyLength = data.reply_length;
        }
        statusText.textContent = "Ready.";
      } else {
        onboardingOverlay.style.display = 'flex';
      }
    }

    // --- Onboarding Logic ---
    function setupOnboarding(){
        const minSpeed = D.getElementById('onboarding-min-speed');
        const maxSpeed = D.getElementById('onboarding-max-speed');
        const speedVal = D.getElementById('onboarding-speed-val');
        const minDepth = D.getElementById('onboarding-min-depth');
        const maxDepth = D.getElementById('onboarding-max-depth');
        const depthVal = D.getElementById('onboarding-depth-val');
        const saveBtn = D.getElementById('onboarding-save-btn');

        function updateSliderLabels() {
            if (parseInt(minSpeed.value) > parseInt(maxSpeed.value)) {
                maxSpeed.value = minSpeed.value;
            }
            speedVal.textContent = `${minSpeed.value} - ${maxSpeed.value}`;

            if (parseInt(minDepth.value) > parseInt(maxDepth.value)) {
                maxDepth.value = minDepth.value;
            }
            depthVal.textContent = `${minDepth.value} - ${maxDepth.value}`;
        }

        [minSpeed, maxSpeed, minDepth, maxDepth].forEach(el => {
            el.addEventListener('input', updateSliderLabels);
        });

        saveBtn.addEventListener('click', async () => {
            const key = D.getElementById('onboarding-key').value.trim();
            const persona = D.getElementById('onboarding-persona').value.trim();
            if (!key) {
                alert('Handy Connection Key is required.');
                return;
            }

            const settings = {
                handy_key: key,
                persona_desc: persona,
                min_speed: minSpeed.value,
                max_speed: maxSpeed.value,
                min_depth: minDepth.value,
                max_depth: maxDepth.value,
            };

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            const res = await apiCall('/save_onboarding_settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (res && res.status === 'ok') {
                location.reload();
            } else {
                alert('Failed to save settings. Please check the server logs.');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save & Start';
            }
        });
    }


    // --- Standard Event Listeners ---
    D.getElementById('edging-mode-btn').addEventListener('click', async ()=>{
      const res = await apiCall('/start_edging_mode', { method:'POST' });
      if (res && res.status === 'error') statusText.textContent = res.message;
    });
    D.getElementById('milking-mode-btn').addEventListener('click', async ()=>{
      const res = await apiCall('/start_milking_mode', { method:'POST' });
      if (res && res.status === 'error') statusText.textContent = res.message;
    });
    D.getElementById('start-auto-btn').addEventListener('click', async ()=>{
      const res = await apiCall('/start_auto_mode', { method:'POST' });
      if (res && res.status === 'error') statusText.textContent = res.message;
    });

    async function emergencyStop(){
      await apiCall('/stop_everything', { method:'POST' });
      if (imCloseBtn) imCloseBtn.style.display = 'none';
      statusText.textContent = 'Stopped.';
    }
    D.getElementById('stop-auto-btn').addEventListener('click', emergencyStop);
    D.getElementById('emergency-stop-all-btn').addEventListener('click', emergencyStop);

    D.getElementById('send-chat-btn').addEventListener('click', ()=> sendUserMessage(userChatInput.value));
    userChatInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendUserMessage(userChatInput.value); });
    D.getElementById('set-persona-btn').addEventListener('click', ()=> {
        myPersonaDescription = personaInput.value.trim();
        statusText.textContent = 'Persona description updated.';
        sendUserMessage('');
    });
    
    D.getElementById('set-ai-name-btn').addEventListener('click', async () => {
        const name = aiNameInput.value.trim();
        if (!name) return;
        await apiCall('/set_ai_name', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
        statusText.textContent = `AI name set to ${name}.`;
    });
    
    D.getElementById('memories-toggle-btn').addEventListener('click', async () => {
        const btn = D.getElementById('memories-toggle-btn');
        const res = await apiCall('/toggle_memory', { method: 'POST' });
        if (res && res.status === 'ok') {
            const state = res.memories_on ? 'ON' : 'OFF';
            btn.textContent = `Memories: ${state}`;
            statusText.textContent = `Long-term memory is now ${state}.`;
        }
    });

    D.querySelectorAll('input[name="reply-length"]').forEach(r=>{
      r.addEventListener('change', async ()=>{
        replyLength = D.querySelector('input[name="reply-length"]:checked').value;
        statusText.textContent = `Reply length set to ${replyLength}.`;
        await fetch('/set_reply_length', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ length: replyLength })});
      });
    });

    pfpUploadInput.addEventListener('change', ()=>{
      const file = pfpUploadInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onloadend = async ()=>{
        const base64 = reader.result;
        pfpPreview.src = base64; typingIndicatorPfp.src = base64;
        const res = await apiCall('/set_profile_picture', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ pfp_b64: base64 })});
        if (res && res.status === 'success' && res.pfp_url){
          pfpPreview.src = res.pfp_url; typingIndicatorPfp.src = res.pfp_url;
        }
      };
      reader.readAsDataURL(file);
    });

    const timingIds = ['auto-min-time','auto-max-time','edging-min-time','edging-max-time','milking-min-time','milking-max-time'];
    function readTimings(){
      const g=id=>parseFloat(D.getElementById(id).value);
      return { auto_min:g('auto-min-time'), auto_max:g('auto-max-time'),
               edging_min:g('edging-min-time'), edging_max:g('edging-max-time'),
               milking_min:g('milking-min-time'), milking_max:g('milking-max-time') };
    }
    timingIds.forEach(id=> D.getElementById(id).addEventListener('change', async ()=>{
      const res = await apiCall('/set_timings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(readTimings()) });
      if (!res || res.status !== 'ok') statusText.textContent = 'Failed to save timings';
      else statusText.textContent = 'Timings saved.';
    }));

    // Polling
    setInterval(()=>{
      fetch('/get_updates').then(async res=>{
        const ct = res.headers.get('content-type');
        if (ct && ct.includes('audio/')) return;
        return res.json();
      }).then(data=>{
        if (!data) return;
        if (data.messages && data.messages.length){
          typingIndicator.style.display = 'none';
          for (const m of data.messages){
            const div = D.createElement('div');
            div.className = 'chat-message-container bot-bubble';
            div.innerHTML = `<img class="chat-pfp" src="${pfpPreview.src}"><div class="message-content"><div class="speaker-name">${(aiNameInput.value||'BOT')}</div><div class="message-bubble">${m}</div></div>`;
            chatMessagesContainer.appendChild(div);
          }
          scrollToBottom();
        }
      });

      fetch('/get_status').then(res=>res.json()).then(data=>{
        if (!data) return;
        const emoji = {'Curious':'🤔','Teasing':'😉','Playful':'😏','Dominant':'😈','Needy':'🥺','Overwhelmed':'🤯','Afterglow':'😌'}[data.mood] || '';
        moodDisplay.textContent = `Mood: ${data.mood} ${emoji}`;
        drawHandyVisualizer(data.speed || 0, data.depth || 0);
        updateModeButtons(data.active_mode);
      });
    }, 500);

    // Startup
    window.addEventListener('resize', ()=>{ resizeCanvas(); scrollToBottom(); });
    document.addEventListener('DOMContentLoaded', ()=>{ 
        resizeCanvas(); 
        startupCheck(); 
        setupOnboarding();
    });
  </script>
</body>
</html>